name: Build and test (OS matrix)

# trigger the workflow on push or pull requests
on: [push, pull_request, workflow_dispatch]

jobs:
  linux:  # (this is the job name)
    strategy:
      fail-fast: false  # don't cancel other jobs in the matrix if one fails
      matrix:
        include:
          # Keep existing Ubuntu versions for compatibility testing
          - runner: ubuntu-24.04
            container: ubuntu:20.04
            os_name: ubuntu-20.04
            redis_image: redis:8.0-alpine
          - runner: ubuntu-24.04
            container: ubuntu:22.04
            os_name: ubuntu-22.04
            redis_image: redis:8.0-alpine
          - runner: ubuntu-24.04
            container: ubuntu:24.04
            os_name: ubuntu-24.04
            redis_image: redis:8.0-alpine
          # Add latest Ubuntu version
          - runner: ubuntu-24.04
            container: ubuntu:25.04
            os_name: ubuntu-25.04
            redis_image: redis:8.2-alpine
          # Keep existing Red Hat versions
          - runner: ubuntu-24.04
            container: redhat/ubi8:8.8
            os_name: redhat-8.8
            redis_image: docker.io/redis:8.0-alpine
          - runner: ubuntu-24.04
            container: redhat/ubi9:9.2
            os_name: redhat-9.2
            redis_image: docker.io/redis:8.0-alpine
          # Add latest Red Hat UBI version
          - runner: ubuntu-24.04
            container: redhat/ubi10:10.1
            os_name: redhat-10.1
            redis_image: docker.io/redis:8.2-alpine

    runs-on: ${{ matrix.runner }}

    services:
      # Make the redis sidecar image configurable in the job matrix
      # Set `redis_image` in the matrix entries above (example: `redis:8.0-alpine`).
      # By moving the image into the matrix, you can test different Redis versions easily.
      redis:
        image: ${{ matrix.redis_image }}

    # run each job in the container specified (ignored for macOS runners that don't use containers)
    container:
      image: ${{ matrix.container }}

    steps:
    - uses: actions/checkout@v4

    - name: Install build essentials (Ubuntu)
      if: contains(matrix.os_name, 'ubuntu-')
      run: |
        apt-get -y update
        DEBIAN_FRONTEND=noninteractive apt-get -y --allow-unauthenticated --allow-downgrades --allow-remove-essential --allow-change-held-packages \
          install curl build-essential

    - name: Install build essentials (Red Hat)
      if: contains(matrix.os_name, 'redhat-')
      run: |
        yum install -y --allowerasing curl gcc gcc-c++ make

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: clippy, rustfmt

    - name: Verify Rust installation
      run: |
        # `actions-rs/toolchain` already installs rustup & rustc and adds it to PATH
        rustc --version
        cargo --version

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/rust-toolchain*') }}

    - name: Build
      run: |
        cargo build --release

    - name: Run tests
      run: |
        cargo test --release

    - name: Archive logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: webdis-${{ matrix.os_name }}.log
        path: webdis.log


  macos: # (again, this is the job name)
    strategy:
      fail-fast: false
      matrix:
        include:
          # Keep existing macOS versions
          - runner: macos-13
            os_name: macos-13
          - runner: macos-14
            os_name: macos-14
          # Add latest macOS version
          - runner: macos-15
            os_name: macos-15

    runs-on: ${{ matrix.runner }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install redis || true

    - name: Set up redis hostname
      run: echo "127.0.0.1 redis" | sudo tee -a /etc/hosts

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: clippy, rustfmt

    - name: Verify Rust installation
      run: |
        rustc --version
        cargo --version

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/rust-toolchain*') }}

    - name: Build
      run: cargo build --release

    - name: Run tests
      run: |
        brew services start redis
        cargo test --release

    - name: Archive logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: webdis-${{ matrix.os_name }}.log
        path: webdis.log
