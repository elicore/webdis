name: Build and test (OS matrix)

# Maintainer Notes:
# - This workflow uses the reusable workflow `.github/workflows/reusable-build.yml` for job logic,
#   and the composite actions in `.github/actions` for Rust setup and build/test logic.
# - `linux` job maps runner/container to arch using explicit `include` rows to reduce matrix sizes.
# - Redis sidecar images are a matrix axis (`redis_image`) and will produce cross-product jobs.
# - To run aarch64 tests under QEMU, configure `arch: aarch64` and the reusable workflow will pass
#   `qemu: true` when appropriate. See the composite action README for details.

# trigger the workflow on push or pull requests
on: [workflow_dispatch]

jobs:
  linux:
    uses: ./.github/workflows/reusable-build.yml
    strategy:
      fail-fast: false
      matrix:
        # Explicit includes allow us to map arch to specific containers and reduce job count
        include:
          # Ubuntu 24.04 - x86
          - runner: ubuntu-24.04
            container: ubuntu:24.04
            os_name: ubuntu-24.04
            arch: x86_64
          # Ubuntu 25.04 - x86
          - runner: ubuntu-24.04
            container: ubuntu:25.04
            os_name: ubuntu-25.04
            arch: x86_64
          # Ubuntu 25.04 - aarch64 (QEMU emulation)
          - runner: ubuntu-24.04
            container: ubuntu:25.04
            os_name: ubuntu-25.04
            arch: aarch64
          # RHEL UBI9 - x86
          - runner: ubuntu-24.04
            container: redhat/ubi9:9.2
            os_name: redhat-9.2
            arch: x86_64
          # RHEL UBI10 - x86
          - runner: ubuntu-24.04
            container: redhat/ubi10:10.1
            os_name: redhat-10.1
            arch: x86_64
        # Redis matrix is still independent
        redis_image:
          - redis:8.2-alpine
        # If you need more Redis versions add them here; the job count will multiply
    with:
      arch: ${{ matrix.arch }}
      runner: ${{ matrix.runner }}
      container: ${{ matrix.container }}
      os_name: ${{ matrix.os_name }}
      redis_image: ${{ matrix.redis_image }}


  macos:
    uses: ./.github/workflows/reusable-build.yml
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            os_name: macos-13
          - runner: macos-14
            os_name: macos-14
          - runner: macos-15
            os_name: macos-15
    with:
      arch: x86_64
      runner: ${{ matrix.runner }}
      container: ''
      os_name: ${{ matrix.os_name }}
      redis_image: ''
